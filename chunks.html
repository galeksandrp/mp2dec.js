<html>

<body>
  <h1>JavaScript mp2 decoder</h1>
  <p>
    JavaScript port of <a href="http://keyj.emphy.de/kjmp2/">http://keyj.emphy.de/kjmp2/</a> . Playback code based on a Mozilla Audio API example from: <a href="https://wiki.mozilla.org/Audio_Data_API">https://wiki.mozilla.org/Audio_Data_API</a>
  </p>
  <h2>API</h2>
  <pre>
// The decoder lives in an iframe you need to load it into your document.
// load the mp2 decoder (doesn't quite work like this yet, in the source you will see I'm doing foo("exports"))
mp2_dec=require("mp2_decoder");

// create mp2 state
var mp2=mp2_dec.kjmp2_make_mp2_state();

// initialise the decoder
mp2_dec.kjmp2_init(mp2);

// get your sample rate (frame is an array containing mp2 data)
var samplerate=mp2_dec.kjmp2_get_sample_rate(frame);

// decode your first frame
// l and r are the output arrays (left and right channel)
// pcm is unused (must be set to an empty array, silly bug)
var bytes_read=mp2_dec.kjmp2_decode_frame(mp2,frame,pcm,l,r);
</pre>
  <h2>Demo:</h2>
  <p>Retrieves whole file, then decodes it in one go. Should work in Firefox 5, and possibly 4. Decoding is scheduled using setTimeout, so keep this tab focused. Audio file is public domain.</p>
  <script src="mp2dec.js"></script>
  <script>
    var t = document.createElement("div");
    document.body.appendChild(t);
    var took = document.createElement("div");
    document.body.appendChild(took);

    mp2_dec = foo("exports");
    kjmp2_get_sample_rate = mp2_dec.kjmp2_get_sample_rate;
    kjmp2_init = mp2_dec.kjmp2_init;
    kjmp2_decode_frame = mp2_dec.kjmp2_decode_frame;

    var get_mp2 = function(f) {
      xhr = new XMLHttpRequest();
      xhr.open("GET", "a.mp2", true);
      xhr.responseType = "arraybuffer";
      xhr.onload = f;
      xhr.send(null);
    };
    var load_mp2_button = document.createElement("button");
    load_mp2_button.innerHTML = "Load mp2";

    decode_frame = function() {
      but.style.display = "none";
      l = [];
      r = [];
      if (bytes_left >= 0) {
        pcm = [];
        value = kjmp2_decode_frame(mp2, frame, pcm, l, r);
        if (value) {
          if (!!(window.AudioContext || window.webkitAudioContext)) {
            if (typeof lchannel === 'undefined') {
              lchannel = new Float32Array(frame.length / value * 1152);
              rchannel = new Float32Array(frame.length / value * 1152);

              context = new(window.AudioContext || window.webkitAudioContext)();
              sndbuffer = context.createBuffer(2, lchannel.length + rchannel.length, 44100);
              setInterval(function() {
                var time = context.currentTime + 1;
                try {
                  source.stop(time);
                }
                catch (e) {

                }
                sndbuffer.copyToChannel(lchannel, 0, 0);
                sndbuffer.copyToChannel(rchannel, 1, 0);
                source = context.createBufferSource();
                source.buffer = sndbuffer;
                source.connect(context.destination);
                source.start(time, time);
                t.innerHTML = "Bytes left to decode: " + bytes_left;
              }, 1000);
            }
            lchannel.set(l, nframe * 1152);
            rchannel.set(r, nframe * 1152);
            nframe++;
          }
          else {
            for (var i = 0; i < l.length; i++) {
              dec.push(l[i]);
              dec.push(r[i]);
            };
          }
          frame = frame.subarray(value);
          bytes_left -= value;
          //t.innerHTML = "Bytes left to decode: " + bytes_left;
          setTimeout(arguments.callee, 0);
        };
      }
      else {
        fin = Date.now();
        took.innerHTML = "Took: " + ((fin - st) / 1000) + "seconds to decode";
      };
    };
    decode_mp2 = function() {
      mp2 = {
        id: null,
        V: [
          [],
          []
        ],
        Voffs: null
      };
      kjmp2_init(mp2);
      sample_rate = kjmp2_get_sample_rate(frame);
      but = document.createElement("button");
      but.innerHTML = "Decode";
      but.onclick = decode_frame;
      document.body.appendChild(but);
      st = Date.now();
      // decode_frame();
    };


    document.body.appendChild(load_mp2_button);
    load_mp2_button.onclick = function() {
      this.parentNode.removeChild(this);
      s = document.createElement("div");
      s.innerHTML = "Loading please wait";
      document.body.appendChild(s);
      get_mp2(function() {
        s.parentNode.removeChild(s);
        dec = [];
        nframe = 0;
        r = [];
        l = [];
        buffer = xhr.response ? xhr.response : xhr.mozResponseArrayBuffer;
        frame = new Uint8Array(buffer);
        bytes_left = frame.length - 100;
        decode_mp2();
      });


    };
  </script>
</body>

</html>
